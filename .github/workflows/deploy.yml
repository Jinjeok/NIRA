name: CI/CD - Deploy Bot & Docs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# GitHub Pages ë°°í¬ë¥¼ ìœ„í•œ ë™ì‹œì„± ì œì–´
concurrency:
  group: "pages"
  cancel-in-progress: false

# GitHub Pages ë°°í¬ ê¶Œí•œ
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # 1. CI ìž‘ì—… (ì½”ë“œ ê²€ì¦)
  ci:
    name: CI (Install / Test)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install bot dependencies
        run: npm ci

  # 2. ë¬¸ì„œ ë¹Œë“œ ë° ë°°í¬ (GitHub Pages)
  docs:
    name: Deploy Docusaurus to GitHub Pages
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js for Docs
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ./docs/package-lock.json

      - name: Install docs dependencies
        working-directory: ./docs
        run: npm ci

      - name: Build docs
        working-directory: ./docs
        run: npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs/build

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # 3. ì„œë²„ ë°°í¬ (Discord Bot)
  deploy-bot:
    name: Deploy Bot to Server
    runs-on: ubuntu-latest
    needs: ci
    if: "github.event_name == 'push' && github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, '[skip deploy]')"
    steps:
      - name: Deploy Bot over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -euo pipefail
            echo "ðŸš€ Bot deploy started at $(date)"
            
            echo "ðŸ“ Move to app directory"
            cd ${{ secrets.DEPLOY_PATH }}

            echo "ðŸ” Check current permissions"
            ls -la .env 2>/dev/null || echo "No .env file found"
            
            echo "ðŸ’¾ Backup .env file with permission fix"
            if [ -f .env ]; then
              # .env ê¶Œí•œì„ ìž„ì‹œë¡œ ë³€ê²½í•˜ì—¬ ë°±ì—… ê°€ëŠ¥í•˜ê²Œ í•¨
              chmod 644 .env
              cp .env .env.backup
              echo "âœ… .env backup created"
            else
              echo "âš ï¸ No .env file to backup"
            fi

            echo "ðŸ›‘ Stop NIRA service"
            sudo systemctl stop ${{ secrets.SERVICE_NAME }}

            echo "ðŸ“¥ Update code from Git"
            git fetch --all -p
            git checkout main
            git pull origin main

            echo "ðŸ” Restore .env file with secure permissions"
            if [ -f .env.backup ]; then
              mv .env.backup .env
              chmod 600 .env  # ë³´ì•ˆ ê¶Œí•œìœ¼ë¡œ ë³µì›
              echo "âœ… .env restored with secure permissions (600)"
            else
              echo "âš ï¸ No .env backup to restore"
              if [ -f .env ]; then
                chmod 600 .env  # ê¸°ì¡´ .env ë³´ì•ˆ ê¶Œí•œ ì ìš©
              fi
            fi

            echo "ðŸ“¦ Install dependencies"
            npm ci --omit=dev

            echo "ðŸ”§ Deploy Discord commands (if script exists)"
            if [ -f "deploy-commands.js" ]; then
              /usr/local/bin/node deploy-commands.js
            fi

            echo "âœ… Start NIRA service"
            sudo systemctl start ${{ secrets.SERVICE_NAME }}

            echo "ðŸ” Verify service status"
            sleep 3
            if sudo systemctl is-active --quiet ${{ secrets.SERVICE_NAME }}; then
              echo "âœ… Bot service is running successfully"
              echo "ðŸ“Š Service status:"
              sudo systemctl status ${{ secrets.SERVICE_NAME }} --no-pager -l
            else
              echo "âŒ Bot service failed to start"
              sudo systemctl status ${{ secrets.SERVICE_NAME }} --no-pager -l
              echo "ðŸ“‹ Recent logs:"
              sudo journalctl -u ${{ secrets.SERVICE_NAME }} --no-pager -l -n 20
              exit 1
            fi

            echo "ðŸŽ‰ Bot deploy completed at $(date)"

  # 4. ë°°í¬ ì™„ë£Œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [docs, deploy-bot]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.docs.result }}" == "success" ]]; then
            echo "âœ… **Documentation deployed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Documentation deployment failed**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.deploy-bot.result }}" == "success" ]]; then
            echo "âœ… **Bot deployed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Bot deployment failed**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Links:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Documentation](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY